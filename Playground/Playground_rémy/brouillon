import sqlite3
import pandas as pd
import numpy as np
import json
import os
import function
depot_info_folder = './data/input_info'
db_path = './data/data.sqlite3' 
depot_note_folder ='./data/input_notes'



        
def file_data_Student(depot_info_folder): 
    for file in [f for f in os.listdir(depot_info_folder)]:
        
        if os.path.splitext(os.path.basename(file))[0] == 'Info_student' :
            db_column_mapping = {
                'Nom': 'NAME',
                'Prénom': 'SURNAME',
                'mail': 'EMAIL',
                'Class': 'CLASS'}
        elif os.path.splitext(os.path.basename(file))[0] == 'Sondage_LV2' :
            file_path = os.path.join(depot_info_folder, file)
            db_column_mapping = {
                'Nom': 'NAME',
                'Prénom': 'SURNAME',
                'mail': 'EMAIL',
                'Langues' : 'LV2'
            }
            
        else:
            print(f"Format de fichier non pris en charge: {file}")
            continue
    
        file_path = os.path.join(depot_info_folder, file)
        if 'Info_student' in file:
            if file.endswith('.csv'):
                df = function.csv_into_dataframe(file_path, db_column_mapping)
                #df.to_sql(desired_table_name, conn, if_exists='append', index=False)

            elif file.endswith('.json'):
                df = function.json_into_dataframe(file_path, db_column_mapping)
                #df.to_sql(desired_table_name, conn, if_exists='append', index=False)

            elif file.endswith('.xlsx'):
                df = function.xlsx_into_dataframe(file_path, db_column_mapping)
                #df.to_sql(desired_table_name, conn, if_exists='append', index=False)

            else:
                print(f"Format de fichier non pris en charge: {file}")

        if 'Sondage_LV2' in file:
            if file.endswith('.csv'):
                function.update_lv2_from_csv(df, file_path)
            elif file.endswith('.json'):
                function.update_lv2_from_json(df, file_path)
            elif file.endswith('.xlsx'):
                function.update_lv2_from_xlsx(df, file_path)
            else:
                print(f"Format de fichier non pris en charge: {file}")
                
    return df



df = file_data_Student(depot_info_folder)
students_info = function.add_student_grade(depot_note_folder, df)

for student in students_info.values:
    print(student)
